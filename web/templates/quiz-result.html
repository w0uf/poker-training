<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats du Quiz - Poker Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1f36 0%, #2d3561 100%);
            color: #e0e7ff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .results-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 30px;
            color: #fff;
        }

        .results-score {
            text-align: center;
            font-size: 5rem;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .analysis-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .context-card-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid;
        }
        .context-card-result.excellent { border-color: #4CAF50; }
        .context-card-result.good { border-color: #7CB342; }
        .context-card-result.average { border-color: #FFB300; }
        .context-card-result.poor { border-color: #FF9800; }
        .context-card-result.bad { border-color: #F44336; }

        .context-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .context-score {
            font-size: 2rem;
            font-weight: 800;
        }

        .context-details {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .errors-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .error-item {
            background: rgba(244, 67, 54, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #f44336;
        }

        .error-hand {
            font-size: 1.1rem;
            font-weight: 700;
            color: #FFB300;
        }

        .error-context {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 3px;
        }

        .error-actions {
            text-align: right;
        }

        .error-your-answer {
            font-size: 0.9rem;
            color: #f44336;
            margin-bottom: 5px;
        }

        .error-correct-answer {
            font-size: 0.9rem;
            color: #4CAF50;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recommendation-item {
            background: rgba(103, 126, 234, 0.15);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #667eea;
        }

        .recommendation-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #6B9FFF;
        }

        .recommendation-text {
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .results-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .results-btn {
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .results-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-retry {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-export {
            background: #43a047;
            color: white;
        }

        .btn-home {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="results-card">
            <!-- SCORE GLOBAL -->
            <div class="results-title">üéØ Quiz Termin√© !</div>
            <div class="results-score">
                <span id="finalScore">0</span>%
            </div>

            <div class="results-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalAnswered">0</div>
                    <div class="stat-label">Questions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCorrect">0</div>
                    <div class="stat-label">Correctes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalIncorrect">0</div>
                    <div class="stat-label">Incorrectes</div>
                </div>
            </div>

            <!-- STATISTIQUES PAR CONTEXTE -->
            <div class="analysis-section">
                <h3 class="section-title">üìä Performance par contexte</h3>
                <div id="contextStats" class="context-stats-grid"></div>
            </div>

            <!-- ERREURS D√âTAILL√âES -->
            <div id="errorsSection" class="analysis-section">
                <h3 class="section-title">‚ùå Vos erreurs (<span id="errorCount">0</span>)</h3>
                <div id="errorsList" class="errors-list"></div>
            </div>

            <!-- RECOMMANDATIONS -->
            <div class="analysis-section">
                <h3 class="section-title">üí° Recommandations</h3>
                <div id="recommendations" class="recommendations-list"></div>
            </div>

            <!-- ACTIONS -->
            <div class="results-actions">
                <button class="results-btn btn-retry" onclick="retryQuiz()">
                    üîÑ Recommencer
                </button>
                <button class="results-btn btn-export" onclick="exportResults()">
                    üìä Exporter CSV
                </button>
                <button class="results-btn btn-home" onclick="goHome()">
                    üè† Accueil
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // R√âCUP√âRATION DES R√âSULTATS
        // ============================================
        let quizResults = [];
        let quizMetadata = {};

        function init() {
            console.log('[RESULTS] Chargement de l\'analyse...');

            // R√©cup√©rer les r√©sultats depuis sessionStorage
            const resultsData = sessionStorage.getItem('quizResults');
            const metadataData = sessionStorage.getItem('quizMetadata');

            if (!resultsData || !metadataData) {
                console.error('[RESULTS] Aucun r√©sultat trouv√©');
                alert('Aucun r√©sultat trouv√©. Veuillez d\'abord terminer un quiz.');
                window.location.href = '/quiz-setup';
                return;
            }

            quizResults = JSON.parse(resultsData);
            quizMetadata = JSON.parse(metadataData);

            console.log('[RESULTS] R√©sultats charg√©s:', quizResults.length, 'questions');

            // Afficher l'analyse
            displayAnalysis();
        }

        // ============================================
        // AFFICHAGE DE L'ANALYSE
        // ============================================
        function displayAnalysis() {
            const totalAnswered = quizResults.length;
            const totalCorrect = quizResults.filter(r => r.is_correct).length;
            const percentage = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;

            displayGlobalScore(percentage, totalCorrect, totalAnswered);
            displayContextStats();
            displayErrors();
            generateRecommendations();
        }

        function displayGlobalScore(percentage, correct, total) {
            document.getElementById('finalScore').textContent = percentage;
            document.getElementById('totalCorrect').textContent = correct;
            document.getElementById('totalAnswered').textContent = total;
            document.getElementById('totalIncorrect').textContent = (total - correct);
        }

        function displayContextStats() {
            const contextGroups = {};
            quizResults.forEach(result => {
                if (!contextGroups[result.context_id]) {
                    contextGroups[result.context_id] = {
                        name: result.context_name,
                        action: result.context_action,
                        total: 0,
                        correct: 0
                    };
                }
                contextGroups[result.context_id].total++;
                if (result.is_correct) {
                    contextGroups[result.context_id].correct++;
                }
            });

            const container = document.getElementById('contextStats');
            container.innerHTML = '';

            Object.entries(contextGroups).forEach(([contextId, stats]) => {
                const percentage = Math.round((stats.correct / stats.total) * 100);
                
                let scoreClass = 'bad';
                if (percentage >= 90) scoreClass = 'excellent';
                else if (percentage >= 75) scoreClass = 'good';
                else if (percentage >= 60) scoreClass = 'average';
                else if (percentage >= 50) scoreClass = 'poor';

                const card = document.createElement('div');
                card.className = `context-card-result ${scoreClass}`;
                card.innerHTML = `
                    <div class="context-name">${stats.name}</div>
                    <div class="context-score">${percentage}%</div>
                    <div class="context-details">${stats.correct}/${stats.total} bonnes r√©ponses</div>
                `;
                container.appendChild(card);
            });
        }

        function displayErrors() {
            const errors = quizResults.filter(r => !r.is_correct);
            
            if (errors.length === 0) {
                document.getElementById('errorsSection').style.display = 'none';
                return;
            }

            document.getElementById('errorsSection').style.display = 'block';
            document.getElementById('errorCount').textContent = errors.length;

            const container = document.getElementById('errorsList');
            container.innerHTML = '';

            errors.forEach(error => {
                const item = document.createElement('div');
                item.className = 'error-item';
                item.innerHTML = `
                    <div>
                        <div class="error-hand">${error.hand}</div>
                        <div class="error-context">${error.context_name}</div>
                    </div>
                    <div class="error-actions">
                        <div class="error-your-answer">Votre r√©ponse : ${translateAction(error.user_answer)}</div>
                        <div class="error-correct-answer">Bonne r√©ponse : ${translateAction(error.correct_answer)}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function generateRecommendations() {
            const recommendations = [];
            const errors = quizResults.filter(r => !r.is_correct);
            const percentage = Math.round((quizResults.filter(r => r.is_correct).length / quizResults.length) * 100);

            // Recommandation selon le score
            if (percentage >= 90) {
                recommendations.push({
                    title: 'üéâ Excellent travail !',
                    text: 'Vous ma√Ætrisez tr√®s bien ces ranges. Vous pouvez maintenant vous concentrer sur des contextes plus complexes.'
                });
            } else if (percentage >= 75) {
                recommendations.push({
                    title: 'üëç Bon niveau',
                    text: 'Vous avez une bonne compr√©hension des ranges. Concentrez-vous sur les erreurs pour atteindre l\'excellence.'
                });
            } else if (percentage >= 60) {
                recommendations.push({
                    title: 'üìö Travail n√©cessaire',
                    text: 'Vous √™tes sur la bonne voie mais certaines situations n√©cessitent plus de r√©vision. Refaites ce quiz r√©guli√®rement.'
                });
            } else {
                recommendations.push({
                    title: 'üéØ R√©vision importante recommand√©e',
                    text: 'Les ranges n√©cessitent plus de travail. Prenez le temps de bien √©tudier chaque contexte avant de refaire le quiz.'
                });
            }

            // Analyser les patterns d'erreurs
            if (errors.length > 0) {
                const errorsByContext = {};
                errors.forEach(error => {
                    if (!errorsByContext[error.context_action]) {
                        errorsByContext[error.context_action] = 0;
                    }
                    errorsByContext[error.context_action]++;
                });

                const sortedContexts = Object.entries(errorsByContext).sort((a, b) => b[1] - a[1]);
                if (sortedContexts.length > 0) {
                    const [topContext, errorCount] = sortedContexts[0];
                    let contextTips = '';
                    
                    switch (topContext) {
                        case 'open':
                            contextTips = 'R√©visez vos ranges d\'ouverture. Faites attention aux positions early vs late et √† l\'ajustement selon le stack.';
                            break;
                        case 'defense':
                            contextTips = 'La d√©fense contre les opens n√©cessite de bien distinguer call et 3bet. √âtudiez les ranges de d√©fense par position.';
                            break;
                        case 'squeeze':
                            contextTips = 'Le squeeze est une situation complexe. Assurez-vous de bien comprendre quand squeezer value vs bluff.';
                            break;
                        case 'vs_limpers':
                            contextTips = 'Contre les limpers, l\'isolation est souvent pr√©f√©rable √† l\'overlimping. R√©visez vos ranges d\'iso raise.';
                            break;
                        default:
                            contextTips = `Concentrez-vous sur les situations de type "${topContext}".`;
                    }

                    recommendations.push({
                        title: `‚ö†Ô∏è Point faible : ${topContext}`,
                        text: `${errorCount} erreur(s) dans ce contexte. ${contextTips}`
                    });
                }

                // D√©tection tight/loose
                const foldErrors = errors.filter(e => e.user_answer === 'FOLD').length;
                const raiseErrors = errors.filter(e => ['RAISE', 'OPEN', '3BET'].includes(e.user_answer)).length;
                
                if (foldErrors > errors.length * 0.6) {
                    recommendations.push({
                        title: 'üìâ Tendance : Trop tight',
                        text: 'Vous foldez trop souvent des mains qui devraient √™tre jou√©es. Travaillez sur l\'√©largissement de vos ranges.'
                    });
                } else if (raiseErrors > errors.length * 0.6) {
                    recommendations.push({
                        title: 'üìà Tendance : Trop loose',
                        text: 'Vous jouez trop de mains de mani√®re agressive. Concentrez-vous sur la s√©lection des mains.'
                    });
                }
            }

            // Afficher
            const container = document.getElementById('recommendations');
            container.innerHTML = '';

            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <div class="recommendation-title">${rec.title}</div>
                    <div class="recommendation-text">${rec.text}</div>
                `;
                container.appendChild(item);
            });
        }

        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================
        function translateAction(action) {
            const translations = {
                'FOLD': 'Fold',
                'CHECK': 'Check',
                'CALL': 'Call',
                'RAISE': 'Raise',
                'OPEN': 'Open',
                '3BET': '3-Bet',
                '4BET': '4-Bet',
                'ALLIN': 'All-in',
                'LIMP': 'Limp'
            };
            return translations[action] || action;
        }

        function exportResults() {
            const headers = ['Main', 'Contexte', 'Action Contexte', 'Votre R√©ponse', 'Bonne R√©ponse', 'R√©sultat'];
            const rows = quizResults.map(r => [
                r.hand,
                r.context_name,
                r.context_action,
                translateAction(r.user_answer),
                translateAction(r.correct_answer),
                r.is_correct ? 'Correct' : 'Incorrect'
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `poker-quiz-results-${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log('[EXPORT] R√©sultats export√©s');
        }

        function retryQuiz() {
            sessionStorage.clear();
            window.location.href = '/quiz-setup';
        }

        function goHome() {
            sessionStorage.clear();
            window.location.href = '/';
        }

        // ============================================
        // INITIALISATION
        // ============================================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
