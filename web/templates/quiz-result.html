<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats du Quiz - Poker Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1f36 0%, #2d3561 100%);
            color: #e0e7ff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .results-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 30px;
            color: #fff;
        }

        .results-score {
            text-align: center;
            font-size: 5rem;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .analysis-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .context-card-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid;
        }
        .context-card-result.excellent { border-color: #4CAF50; }
        .context-card-result.good { border-color: #7CB342; }
        .context-card-result.average { border-color: #FFB300; }
        .context-card-result.poor { border-color: #FF9800; }
        .context-card-result.bad { border-color: #F44336; }

        .context-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .context-score {
            font-size: 2rem;
            font-weight: 800;
        }

        .context-details {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .errors-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .error-item {
            background: rgba(244, 67, 54, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #f44336;
        }

        .error-hand {
            font-size: 1.1rem;
            font-weight: 700;
            color: #FFB300;
        }

        .error-context {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 3px;
        }

        .error-actions {
            text-align: right;
        }

        .error-your-answer {
            font-size: 0.9rem;
            color: #f44336;
            margin-bottom: 5px;
        }

        .error-correct-answer {
            font-size: 0.9rem;
            color: #4CAF50;
        }

        /* Styles pour la s√©quence */
        .error-sequence {
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .error-sequence-title {
            color: #6B9FFF;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .error-sequence-history {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .seq-step {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .seq-step.hero {
            background: rgba(103, 126, 234, 0.2);
            color: #6B9FFF;
        }

        .seq-step.villain {
            background: rgba(244, 67, 54, 0.2);
            color: #FF8A80;
        }

        .seq-step.error-step {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recommendation-item {
            background: rgba(103, 126, 234, 0.15);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #667eea;
        }

        .recommendation-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #6B9FFF;
        }

        .recommendation-text {
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .results-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .results-btn {
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .results-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-retry {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-export {
            background: #43a047;
            color: white;
        }

        .btn-home {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e7ff;
        }

        /* üÜï NOUVELLES SECTIONS - PROGRESSION */
        .progression-section {
            background: linear-gradient(135deg, rgba(103, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 16px;
            padding: 30px;
            margin-top: 40px;
            border: 1px solid rgba(103, 126, 234, 0.3);
        }

        .progression-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .progression-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-view-history {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-view-history:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(103, 126, 234, 0.4);
        }

        .global-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .global-stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .global-stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .global-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 5px;
        }

        .global-stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .global-stat-trend {
            font-size: 0.8rem;
            margin-top: 8px;
            font-weight: 600;
        }

        .trend-up {
            color: #4CAF50;
        }

        .trend-down {
            color: #f44336;
        }

        .trend-stable {
            color: #FFB300;
        }

        .mini-chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .mini-chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #6B9FFF;
        }

        #miniProgressChart {
            width: 100%;
            height: 200px;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: #667eea;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .results-stats {
                grid-template-columns: 1fr;
            }

            .global-stats-grid {
                grid-template-columns: 1fr;
            }

            .progression-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .btn-view-history {
                text-align: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="results-card">
            <h1 class="results-title">üéØ R√©sultats du Quiz</h1>
            
            <!-- Score principal -->
            <div class="results-score" id="finalScore">--</div>
            
            <!-- Statistiques principales -->
            <div class="results-stats">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">--</div>
                    <div class="stat-label">Correctes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalQuestions">--</div>
                    <div class="stat-label">Questions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="errorCount">--</div>
                    <div class="stat-label">Erreurs</div>
                </div>
            </div>

            <!-- Stats par contexte -->
            <div class="analysis-section">
                <div class="section-title">
                    üìä Performance par contexte
                </div>
                <div class="context-stats-grid" id="contextStats"></div>
            </div>

            <!-- Erreurs d√©taill√©es -->
            <div class="analysis-section" id="errorsSection" style="display: none;">
                <div class="section-title">
                    ‚ùå Erreurs √† r√©viser
                </div>
                <div class="errors-list" id="errorsList"></div>
            </div>

            <!-- Recommandations -->
            <div class="analysis-section">
                <div class="section-title">
                    üí° Recommandations
                </div>
                <div class="recommendations-list" id="recommendations"></div>
            </div>

            <!-- Actions principales -->
            <div class="results-actions">
                <button class="results-btn btn-retry" onclick="retryQuiz()">
                    üîÑ Refaire le quiz
                </button>
                <button class="results-btn btn-export" onclick="exportResults()">
                    üíæ Exporter CSV
                </button>
                <button class="results-btn btn-home" onclick="goHome()">
                    üè† Accueil
                </button>
            </div>
        </div>

        <!-- üÜï SECTION PROGRESSION -->
        <div class="progression-section">
            <div class="progression-header">
                <h2 class="progression-title">
                    üìà Votre progression
                </h2>
                <a href="/history" class="btn-view-history">
                    üìä Voir l'historique complet
                    <span>‚Üí</span>
                </a>
            </div>

            <!-- Stats globales -->
            <div id="globalStatsContainer" class="loading-spinner">
                Chargement des statistiques...
            </div>

            <!-- Mini graphique -->
            <div class="mini-chart-container">
                <div class="mini-chart-title">üìâ 5 derni√®res sessions</div>
                <canvas id="miniProgressChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DONN√âES ET √âTAT
        // ============================================
        let quizResults = [];
        let progressionData = null;

        // ============================================
        // INITIALISATION
        // ============================================
        function init() {
            loadResults();
            displayResults();
            analyzeByContext();
            displayErrors();
            generateRecommendations();
            
            // üÜï Charger les donn√©es de progression
            loadProgressionData();
        }

        function loadResults() {
            const resultsData = sessionStorage.getItem('quizResults');
            if (resultsData) {
                quizResults = JSON.parse(resultsData);
                console.log('[RESULTS] R√©sultats charg√©s:', quizResults.length);
            } else {
                console.error('[ERROR] Aucun r√©sultat trouv√©');
                alert('Aucun r√©sultat trouv√©. Retour √† l\'accueil.');
                window.location.href = '/';
            }
        }

        // ============================================
        // AFFICHAGE DES R√âSULTATS
        // ============================================
        function displayResults() {
            const correct = quizResults.filter(r => r.is_correct).length;
            const total = quizResults.length;
            const percentage = Math.round((correct / total) * 100);

            document.getElementById('finalScore').textContent = percentage + '%';
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('errorCount').textContent = total - correct;
        }

        function analyzeByContext() {
            const contextMap = {};

            quizResults.forEach(result => {
                const key = result.context_action;
                if (!contextMap[key]) {
                    contextMap[key] = {
                        name: result.context_name,
                        correct: 0,
                        total: 0
                    };
                }
                contextMap[key].total++;
                if (result.is_correct) {
                    contextMap[key].correct++;
                }
            });

            const container = document.getElementById('contextStats');
            container.innerHTML = '';

            Object.entries(contextMap).forEach(([key, data]) => {
                const percentage = Math.round((data.correct / data.total) * 100);
                let performanceClass = 'bad';
                if (percentage >= 90) performanceClass = 'excellent';
                else if (percentage >= 75) performanceClass = 'good';
                else if (percentage >= 60) performanceClass = 'average';
                else if (percentage >= 40) performanceClass = 'poor';

                const card = document.createElement('div');
                card.className = `context-card-result ${performanceClass}`;
                card.innerHTML = `
                    <div class="context-name">${data.name}</div>
                    <div class="context-score">${percentage}%</div>
                    <div class="context-details">${data.correct}/${data.total} correctes</div>
                `;
                container.appendChild(card);
            });
        }

        function displayErrors() {
            const errors = quizResults.filter(r => !r.is_correct);
            
            if (errors.length === 0) {
                document.getElementById('errorsSection').style.display = 'none';
                return;
            }

            document.getElementById('errorsSection').style.display = 'block';
            const container = document.getElementById('errorsList');
            container.innerHTML = '';

            errors.forEach(error => {
                const item = document.createElement('div');
                item.className = 'error-item';
                
                let content = `
                    <div>
                        <div class="error-hand">${formatHand(error.hand)}</div>
                        <div class="error-context">${error.context_name}</div>
                `;
                
                if (error.sequence_history && error.sequence_history.levels) {
                    content += `
                        <div class="error-sequence">
                            <div class="error-sequence-title">üìã S√©quence :</div>
                            <div class="error-sequence-history">
                                ${formatSequence(error.sequence_history, error.villain_position)}
                            </div>
                        </div>
                    `;
                }
                
                content += `
                    </div>
                    <div class="error-actions">
                        <div class="error-your-answer">‚ùå Votre r√©ponse : ${translateAction(error.user_answer)}</div>
                        <div class="error-correct-answer">‚úÖ Bonne r√©ponse : ${translateAction(error.correct_answer)}</div>
                    </div>
                `;
                
                item.innerHTML = content;
                container.appendChild(item);
            });
        }
        
        function formatHand(hand) {
            if (!hand) return '';
            return hand
                .replace(/s/g, '‚ô†')
                .replace(/h/g, '‚ô•')
                .replace(/d/g, '‚ô¶')
                .replace(/c/g, '‚ô£');
        }
        
        function formatSequence(sequenceHistory, villainPos) {
            if (!sequenceHistory || !sequenceHistory.levels) return '';
            
            const parts = [];
            sequenceHistory.levels.forEach((level, idx) => {
                if (idx === 0) {
                    parts.push(`<span class="seq-step hero">Vous ${translateAction(level.hero_action)}</span>`);
                } else {
                    if (level.villain_reaction) {
                        const villainText = level.villain_reaction.text || 
                            `${villainPos} ${translateAction(level.villain_reaction.action)}`;
                        parts.push(`<span class="seq-step villain">${villainText}</span>`);
                    }
                    
                    if (level.user_answer) {
                        const isError = idx === sequenceHistory.levels.length - 1;
                        const errorClass = isError ? ' error-step' : '';
                        parts.push(`<span class="seq-step hero${errorClass}">Vous ${translateAction(level.user_answer)}</span>`);
                    } else if (level.hero_action) {
                        parts.push(`<span class="seq-step hero">Vous ${translateAction(level.hero_action)}</span>`);
                    }
                }
            });
            
            return parts.join(' ‚Üí ');
        }

        function generateRecommendations() {
            const recommendations = [];
            const errors = quizResults.filter(r => !r.is_correct);
            const percentage = Math.round((quizResults.filter(r => r.is_correct).length / quizResults.length) * 100);

            if (percentage >= 90) {
                recommendations.push({
                    title: 'üéâ Excellent travail !',
                    text: 'Vous ma√Ætrisez tr√®s bien ces ranges. Vous pouvez maintenant vous concentrer sur des contextes plus complexes.'
                });
            } else if (percentage >= 75) {
                recommendations.push({
                    title: 'üëç Bon niveau',
                    text: 'Vous avez une bonne compr√©hension des ranges. Concentrez-vous sur les erreurs pour atteindre l\'excellence.'
                });
            } else if (percentage >= 60) {
                recommendations.push({
                    title: 'üìö Travail n√©cessaire',
                    text: 'Vous √™tes sur la bonne voie mais certaines situations n√©cessitent plus de r√©vision. Refaites ce quiz r√©guli√®rement.'
                });
            } else {
                recommendations.push({
                    title: 'üéØ R√©vision importante recommand√©e',
                    text: 'Les ranges n√©cessitent plus de travail. Prenez le temps de bien √©tudier chaque contexte avant de refaire le quiz.'
                });
            }

            if (errors.length > 0) {
                const errorsByContext = {};
                errors.forEach(error => {
                    if (!errorsByContext[error.context_action]) {
                        errorsByContext[error.context_action] = 0;
                    }
                    errorsByContext[error.context_action]++;
                });

                const sortedContexts = Object.entries(errorsByContext).sort((a, b) => b[1] - a[1]);
                if (sortedContexts.length > 0) {
                    const [topContext, errorCount] = sortedContexts[0];
                    let contextTips = '';
                    
                    switch (topContext) {
                        case 'open':
                            contextTips = 'R√©visez vos ranges d\'ouverture. Faites attention aux positions early vs late et √† l\'ajustement selon le stack.';
                            break;
                        case 'defense':
                            contextTips = 'La d√©fense contre les opens n√©cessite de bien distinguer call et 3bet. √âtudiez les ranges de d√©fense par position.';
                            break;
                        case 'squeeze':
                            contextTips = 'Le squeeze est une situation complexe. Assurez-vous de bien comprendre quand squeezer value vs bluff.';
                            break;
                        case 'vs_limpers':
                            contextTips = 'Contre les limpers, l\'isolation est souvent pr√©f√©rable √† l\'overlimping. R√©visez vos ranges d\'iso raise.';
                            break;
                        default:
                            contextTips = `Concentrez-vous sur les situations de type "${topContext}".`;
                    }

                    recommendations.push({
                        title: `‚ö†Ô∏è Point faible : ${topContext}`,
                        text: `${errorCount} erreur(s) dans ce contexte. ${contextTips}`
                    });
                }

                const foldErrors = errors.filter(e => e.user_answer === 'FOLD').length;
                const raiseErrors = errors.filter(e => ['RAISE', 'OPEN', '3BET'].includes(e.user_answer)).length;
                
                if (foldErrors > errors.length * 0.6) {
                    recommendations.push({
                        title: 'üìâ Tendance : Trop tight',
                        text: 'Vous foldez trop souvent des mains qui devraient √™tre jou√©es. Travaillez sur l\'√©largissement de vos ranges.'
                    });
                } else if (raiseErrors > errors.length * 0.6) {
                    recommendations.push({
                        title: 'üìà Tendance : Trop loose',
                        text: 'Vous jouez trop de mains de mani√®re agressive. Concentrez-vous sur la s√©lection des mains.'
                    });
                }
            }

            const container = document.getElementById('recommendations');
            container.innerHTML = '';

            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <div class="recommendation-title">${rec.title}</div>
                    <div class="recommendation-text">${rec.text}</div>
                `;
                container.appendChild(item);
            });
        }

        // ============================================
        // üÜï PROGRESSION ET STATISTIQUES GLOBALES
        // ============================================
        async function loadProgressionData() {
            try {
                const response = await fetch('/api/quiz/progression');
                if (!response.ok) {
                    throw new Error('Erreur lors du chargement des donn√©es');
                }
                
                progressionData = await response.json();
                console.log('[PROGRESSION] Donn√©es charg√©es:', progressionData);
                
                displayGlobalStats();
                displayMiniChart();
            } catch (error) {
                console.error('[ERROR] Erreur chargement progression:', error);
                document.getElementById('globalStatsContainer').innerHTML = `
                    <div class="no-data">
                        Impossible de charger les statistiques. Premi√®re session ?
                    </div>
                `;
            }
        }

        function displayGlobalStats() {
            const container = document.getElementById('globalStatsContainer');
            
            if (!progressionData || !progressionData.sessions || progressionData.sessions.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        C'est votre premi√®re session ! Continuez √† vous entra√Æner pour voir vos statistiques globales.
                    </div>
                `;
                return;
            }

            const stats = progressionData.overall_stats;
            const currentScore = Math.round((quizResults.filter(r => r.is_correct).length / quizResults.length) * 100);
            
            // Calculer la tendance
            let trend = 'stable';
            let trendText = '‚Üí Stable';
            let trendClass = 'trend-stable';
            
            if (progressionData.sessions.length > 1) {
                const previousScore = progressionData.sessions[progressionData.sessions.length - 2].score_percentage;
                const diff = currentScore - previousScore;
                
                if (diff > 5) {
                    trend = 'up';
                    trendText = `‚Üó +${diff}%`;
                    trendClass = 'trend-up';
                } else if (diff < -5) {
                    trend = 'down';
                    trendText = `‚Üò ${diff}%`;
                    trendClass = 'trend-down';
                }
            }

            container.innerHTML = `
                <div class="global-stats-grid">
                    <div class="global-stat-card">
                        <div class="global-stat-icon">üèÜ</div>
                        <div class="global-stat-value">${stats.best_score}%</div>
                        <div class="global-stat-label">Meilleur score</div>
                    </div>
                    
                    <div class="global-stat-card">
                        <div class="global-stat-icon">üìä</div>
                        <div class="global-stat-value">${stats.average_score}%</div>
                        <div class="global-stat-label">Score moyen</div>
                        <div class="global-stat-trend ${trendClass}">${trendText}</div>
                    </div>
                    
                    <div class="global-stat-card">
                        <div class="global-stat-icon">üéØ</div>
                        <div class="global-stat-value">${stats.total_sessions}</div>
                        <div class="global-stat-label">Sessions totales</div>
                    </div>
                    
                    <div class="global-stat-card">
                        <div class="global-stat-icon">‚úÖ</div>
                        <div class="global-stat-value">${stats.total_questions}</div>
                        <div class="global-stat-label">Questions r√©pondues</div>
                    </div>
                </div>
            `;
        }

        function displayMiniChart() {
            const canvas = document.getElementById('miniProgressChart');
            const ctx = canvas.getContext('2d');
            
            if (!progressionData || !progressionData.sessions || progressionData.sessions.length === 0) {
                canvas.height = 100;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.font = '14px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donn√©e disponible', canvas.width / 2, 50);
                return;
            }

            // Prendre les 5 derni√®res sessions
            const sessions = progressionData.sessions.slice(-5);
            
            // Configuration du canvas
            const width = canvas.offsetWidth;
            const height = 200;
            canvas.width = width;
            canvas.height = height;
            
            const padding = 40;
            const chartWidth = width - (padding * 2);
            const chartHeight = height - (padding * 2);
            
            // Trouver min et max pour l'√©chelle
            const scores = sessions.map(s => s.score_percentage);
            const minScore = Math.max(0, Math.min(...scores) - 10);
            const maxScore = Math.min(100, Math.max(...scores) + 10);
            const scoreRange = maxScore - minScore;
            
            // Fonction pour convertir score en position Y
            const getY = (score) => {
                return padding + chartHeight - ((score - minScore) / scoreRange * chartHeight);
            };
            
            // Fonction pour convertir index en position X
            const getX = (index) => {
                return padding + (index / (sessions.length - 1)) * chartWidth;
            };
            
            // Dessiner la grille
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (i / 4) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Dessiner la ligne de progression
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            sessions.forEach((session, index) => {
                const x = getX(index);
                const y = getY(session.score_percentage);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Dessiner les points
            sessions.forEach((session, index) => {
                const x = getX(index);
                const y = getY(session.score_percentage);
                
                // Point
                ctx.fillStyle = '#667eea';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();
                
                // Bordure blanche
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Score au-dessus du point
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText(`${session.score_percentage}%`, x, y - 15);
                
                // Date en bas
                const date = new Date(session.completed_at);
                const dateStr = `${date.getDate()}/${date.getMonth() + 1}`;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.font = '10px Segoe UI';
                ctx.fillText(dateStr, x, height - padding + 20);
            });
        }

        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================
        function translateAction(action) {
            const translations = {
                'FOLD': 'Fold',
                'CHECK': 'Check',
                'CALL': 'Call',
                'RAISE': 'Raise',
                'OPEN': 'Open',
                '3BET': '3-Bet',
                '4BET': '4-Bet',
                'ALLIN': 'All-in',
                'LIMP': 'Limp'
            };
            return translations[action] || action;
        }

        function exportResults() {
            const headers = ['Main', 'Contexte', 'Action Contexte', 'Votre R√©ponse', 'Bonne R√©ponse', 'R√©sultat'];
            const rows = quizResults.map(r => [
                r.hand,
                r.context_name,
                r.context_action,
                translateAction(r.user_answer),
                translateAction(r.correct_answer),
                r.is_correct ? 'Correct' : 'Incorrect'
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `poker-quiz-results-${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log('[EXPORT] R√©sultats export√©s');
        }

        function retryQuiz() {
            sessionStorage.clear();
            window.location.href = '/quiz-setup';
        }

        function goHome() {
            sessionStorage.clear();
            window.location.href = '/';
        }

        // ============================================
        // INITIALISATION
        // ============================================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
