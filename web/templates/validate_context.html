<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation du contexte - Poker Training</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 { color: #333; font-size: 24px; margin-bottom: 10px; }

        .context-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .context-info p { color: #666; margin: 5px 0; font-size: 14px; }
        .context-info strong { color: #333; }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 5px;
            padding: 12px 15px;
            margin: 15px 0;
        }

        .warning-box h3 {
            color: #856404;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .warning-box ul {
            margin: 0;
            padding-left: 20px;
            color: #856404;
            font-size: 13px;
        }

        .warning-box li { margin: 4px 0; }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section { margin-bottom: 30px; }
        .form-section h2 {
            color: #333; font-size: 18px; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 2px solid #667eea;
        }
        .form-section.optional h2 { border-bottom-color: #95a5a6; }
        .form-section.subranges h2 { border-bottom-color: #e74c3c; }
        .form-section.context-details h2 { border-bottom-color: #3498db; }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; color: #555; font-weight: 600;
            margin-bottom: 8px; font-size: 14px;
        }
        .form-group label .required { color: #e74c3c; margin-left: 3px; }

        .form-group select, .form-group input {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 5px; font-size: 14px; transition: border-color 0.3s;
        }
        .form-group select:focus, .form-group input:focus {
            outline: none; border-color: #667eea;
        }

        .button-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px; margin-top: 8px;
        }

        .btn-option {
            padding: 10px; border: 2px solid #e0e0e0; background: white;
            border-radius: 5px; cursor: pointer; transition: all 0.3s;
            font-size: 13px; font-weight: 500;
        }
        .btn-option:hover { border-color: #667eea; background: #f8f9ff; }
        .btn-option.selected { background: #667eea; color: white; border-color: #667eea; }
        .btn-option:disabled { opacity: 0.5; cursor: not-allowed; }

        /* üÜï Styles pour les champs dynamiques multiway */
        .dynamic-section {
            display: none;
            background: #f0f7ff;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            margin-top: 15px;
        }

        .dynamic-section.visible {
            display: block;
        }

        .dynamic-section h3 {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .position-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 2px dashed #ddd;
        }

        .position-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
        }

        .position-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            margin-left: 4px;
        }

        .add-position-btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .add-position-btn:hover {
            background: #2980b9;
        }

        .actions {
            display: flex; gap: 15px; margin-top: 30px;
            padding-top: 20px; border-top: 1px solid #e0e0e0;
        }
        .btn { flex: 1; padding: 15px 30px; border: none; border-radius: 5px;
              font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }

        .message { padding: 15px 20px; border-radius: 5px; margin-bottom: 20px; font-weight: 500; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* --- Table d'√©dition des sous-ranges --- */
        .subranges-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        .subranges-table thead {
            background: #f8f9fa;
        }

        .subranges-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 13px;
            border-bottom: 2px solid #e0e0e0;
        }

        .subranges-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .subranges-table tbody tr:hover {
            background: #f8f9fa;
        }

        .range-color-cell {
            width: 40px;
        }

        .range-color-indicator {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid #e0e0e0;
        }

        .range-name-cell {
            font-weight: 600;
            color: #333;
        }

        .range-hands-cell {
            color: #666;
            text-align: center;
            width: 100px;
        }

        .range-label-cell {
            width: 200px;
        }

        .range-label-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .range-label-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .range-label-select.modified {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .badges, .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .badge, .chip {
            font-size: 12px; font-weight: 600; padding: 6px 10px; border-radius: 999px;
            background: #eef2ff; color: #334155; border: 1px solid #e2e8f0;
        }
        .slug-row { display: flex; align-items: center; gap: 8px; }
        .copy-btn {
            padding: 8px 14px;
            font-size: 13px;
            border: 1px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background: #667eea;
            color: white;
        }
        .copy-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .small-dim { font-size: 12px; color: #666; }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .modified-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Validation du contexte</h1>

            <div class="context-info">
                <p><strong>Fichier :</strong> <span id="filename">-</span></p>
                <p><strong>Nom original :</strong> <span id="original-name">-</span></p>
                <p><strong>Ranges :</strong> <span id="range-count">0</span></p>

                <p><strong>Titre :</strong> <span id="human-title">‚Äî</span></p>
                <p class="slug-row">
                    <strong>Slug :</strong> <code id="slug">‚Äî</code>
                    <button type="button" class="copy-btn" id="rename-btn" onclick="renameFile()">
                        Renommer le fichier
                    </button>
                </p>
                <div>
                    <strong>R√©sum√© sous-ranges :</strong>
                    <div class="chips" id="subranges-summary">
                        <span class="small-dim">Aucun sous-range d√©tect√©</span>
                    </div>
                </div>
            </div>

            <div id="warnings-container"></div>
        </div>

        <div class="form-container">
            <div id="message-container"></div>

            <form id="validation-form">
                <!-- M√©tadonn√©es obligatoires -->
                <div class="form-section">
                    <h2>üìã M√©tadonn√©es obligatoires</h2>

                    <div class="form-group">
                        <label>Format de table <span class="required">*</span></label>
                        <div class="button-grid" id="table-format-buttons">
                            <button type="button" class="btn-option" data-value="6max">6max</button>
                            <button type="button" class="btn-option" data-value="9max">9max</button>
                            <button type="button" class="btn-option" data-value="5max">5max</button>
                            <button type="button" class="btn-option" data-value="HU">HU</button>
                        </div>
                        <input type="hidden" id="table-format" name="table_format" required>
                    </div>

                    <div class="form-group">
                        <label>Position h√©ros <span class="required">*</span></label>
                        <div class="button-grid" id="hero-position-buttons">
                            <!-- Dynamiquement rempli selon le format -->
                        </div>
                        <input type="hidden" id="hero-position" name="hero_position" required>
                    </div>

                    <div class="form-group">
                        <label>Action principale <span class="required">*</span></label>
                        <p class="help-text">
                            S√©lectionnez le type de situation de jeu principale
                        </p>
                        <div class="button-grid">
                            <button type="button" class="btn-option action-btn" data-value="open">üéØ Open</button>
                            <button type="button" class="btn-option action-btn" data-value="defense">üõ°Ô∏è Defense</button>
                            <button type="button" class="btn-option action-btn" data-value="squeeze">ü§è Squeeze</button>
                            <button type="button" class="btn-option action-btn" data-value="vs_limpers">üêå Vs Limpers</button>
                        </div>
                        <input type="hidden" id="primary-action" name="primary_action" required>
                    </div>
                </div>

                <!-- üÜï Section contexte d√©taill√© (dynamique selon primary_action) -->
                <div class="form-section context-details">
                    <h2>üé≤ D√©tails du contexte</h2>

                    <!-- Defense : opener -->
                    <div id="defense-details" class="dynamic-section">
                        <h3>üõ°Ô∏è Defense (heads-up)</h3>
                        <p class="help-text">Vous d√©fendez face √† une ouverture unique</p>
                        <div class="form-group">
                            <label>Position de l'ouvreur <span class="required">*</span></label>
                            <div class="button-grid" id="opener-buttons">
                                <!-- Rempli dynamiquement -->
                            </div>
                            <input type="hidden" id="opener" name="opener">
                        </div>
                    </div>

                    <!-- Squeeze : opener + callers -->
                    <div id="squeeze-details" class="dynamic-section">
                        <h3>ü§è Squeeze (multiway)</h3>
                        <p class="help-text">Vous squeezez face √† une ouverture + call(s)</p>

                        <div class="form-group">
                            <label>Position de l'ouvreur <span class="required">*</span></label>
                            <div class="button-grid" id="squeeze-opener-buttons">
                                <!-- Rempli dynamiquement -->
                            </div>
                            <input type="hidden" id="squeeze-opener" name="squeeze_opener">
                        </div>

                        <div class="form-group">
                            <label>Caller(s) <span class="required">*</span></label>
                            <p class="help-text">S√©lectionnez les positions qui ont call√© l'ouverture</p>
                            <div class="position-tag-container" id="callers-container">
                                <span class="small-dim">Aucun caller s√©lectionn√©</span>
                            </div>
                            <div class="button-grid" id="callers-buttons" style="margin-top: 10px;">
                                <!-- Rempli dynamiquement -->
                            </div>
                            <input type="hidden" id="callers" name="callers">
                        </div>
                    </div>

                    <!-- Vs Limpers : limpers -->
                    <div id="limpers-details" class="dynamic-section">
                        <h3>üêå Vs Limpers (multiway)</h3>
                        <p class="help-text">Vous agissez face √† un ou plusieurs limps</p>

                        <div class="form-group">
                            <label>Limpeur(s) <span class="required">*</span></label>
                            <p class="help-text">S√©lectionnez les positions qui ont limp√©</p>
                            <div class="position-tag-container" id="limpers-container">
                                <span class="small-dim">Aucun limpeur s√©lectionn√©</span>
                            </div>
                            <div class="button-grid" id="limpers-buttons" style="margin-top: 10px;">
                                <!-- Rempli dynamiquement -->
                            </div>
                            <input type="hidden" id="limpers" name="limpers">
                        </div>
                    </div>
                </div>

                <!-- M√©tadonn√©es optionnelles -->
                <div class="form-section optional">
                    <h2>‚öôÔ∏è M√©tadonn√©es optionnelles</h2>

                    <div class="form-group">
                        <label>Profondeur de stack</label>
                        <select id="stack-depth" name="stack_depth">
                            <option value="100bb" selected>100bb (Standard)</option>
                            <option value="20bb">20bb (Short)</option>
                            <option value="50bb">50bb (Medium)</option>
                            <option value="200bb">200bb+ (Deep)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Type de jeu</label>
                        <select id="game-type" name="game_type">
                            <option value="Cash Game" selected>Cash Game</option>
                            <option value="Tournament">Tournament</option>
                            <option value="Sit & Go">Sit & Go</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Variante</label>
                        <select id="variant" name="variant">
                            <option value="NLHE" selected>NLHE (No Limit Hold'em)</option>
                            <option value="PLO">PLO (Pot Limit Omaha)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sizing</label>
                        <input type="text" id="sizing" name="sizing" placeholder="ex: 2.5x, 3bb, pot...">
                    </div>

                    <div class="form-group">
                        <label>Stakes</label>
                        <input type="text" id="stakes" name="stakes" placeholder="ex: NL10, NL25, NL50...">
                    </div>
                </div>

                <!-- Section validation sous-ranges -->
                <div class="form-section subranges">
                    <h2>üéØ Classification des sous-ranges <span id="modified-count"></span></h2>
                    <p class="help-text">
                        V√©rifiez et corrigez si n√©cessaire les labels de chaque sous-range.
                        Les modifications sont indiqu√©es en rouge.
                    </p>

                    <table class="subranges-table" id="subranges-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Nom du range</th>
                                <th>Mains</th>
                                <th>Classification</th>
                            </tr>
                        </thead>
                        <tbody id="subranges-tbody">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                </div>

                <!-- Checkbox pour mise √† jour JSON -->
                <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="update-json" name="update_json" style="width: auto; margin-right: 10px;">
                        <span>‚úì Mettre √† jour le fichier JSON source avec ces m√©tadonn√©es</span>
                    </label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px; margin-left: 30px;">
                        Les m√©tadonn√©es valid√©es seront sauvegard√©es dans le fichier JSON d'origine.
                        Cela permettra une d√©tection automatique √† 100% lors du prochain import.
                    </p>
                </div>

                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">
                        ‚Üê Annuler
                    </button>
                    <button type="button" class="btn btn-danger" id="btn-ignore">
                        üóëÔ∏è Marquer non exploitable
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ‚úì Valider et sauvegarder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const POSITIONS_BY_FORMAT = {
            '5max': ['UTG', 'CO', 'BTN', 'SB', 'BB'],
            '6max': ['UTG', 'MP', 'CO', 'BTN', 'SB', 'BB'],
            '9max': ['UTG', 'UTG+1', 'MP', 'MP+1', 'LJ', 'HJ', 'CO', 'BTN', 'SB', 'BB'],
            'HU': ['BTN', 'BB']
        };

        let contextId = null;
        let contextData = null;
        let modifiedLabels = {};
        let originalLabels = {};
        let selectedCallers = [];
        let selectedLimpers = [];
        let currentTableFormat = '6max';

        // Charger les donn√©es du contexte
        async function loadContext() {
            const urlParams = new URLSearchParams(window.location.search);
            contextId = urlParams.get('id');

            if (!contextId) {
                showMessage('Erreur : ID de contexte manquant', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/validation/context/${contextId}`);
                const data = await response.json();

                if (data.error) {
                    showMessage(data.error, 'error');
                    return;
                }

                contextData = data;

                (data.ranges || []).forEach(r => {
                    originalLabels[r.id] = r.label_canon;
                });

                displayContextInfo(data);
                displayWarnings(data.warnings || []);
                prefillForm(data);
                renderSubrangesTable(data.ranges || [], data.available_labels || {});
                checkFileExists(data.file_path);
            } catch (error) {
                showMessage('Erreur lors du chargement du contexte', 'error');
                console.error(error);
            }
        }

        async function checkFileExists(filePath) {
            try {
                const response = await fetch('/api/orphans/check');
                const data = await response.json();

                const isOrphan = data.orphans.some(o => o.context_id === contextId);

                if (isOrphan) {
                    const warningHtml = `
                        <div class="message error" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>‚ö†Ô∏è <strong>Fichier JSON manquant</strong> - Le fichier source n'existe plus. Certaines fonctionnalit√©s sont limit√©es.</span>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="rebuildJSON()" class="btn btn-warning" style="padding: 8px 16px; font-size: 13px;">
                                    üîÑ Reconstruire
                                </button>
                                <button onclick="window.location.href='/orphans'" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                    G√©rer les orphelins
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('message-container').innerHTML = warningHtml;
                }
            } catch (error) {
                console.error('Erreur check fichier:', error);
            }
        }

        async function rebuildJSON() {
            if (!confirm('Reconstruire le fichier JSON depuis la base de donn√©es ?')) return;

            try {
                const response = await fetch(`/api/orphans/rebuild/${contextId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('‚úÖ JSON reconstruit avec succ√®s', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage('Erreur lors de la reconstruction', 'error');
            }
        }

        function displayWarnings(warnings) {
            const container = document.getElementById('warnings-container');
            if (!warnings || warnings.length === 0) {
                container.innerHTML = '';
                return;
            }

            const html = `
                <div class="warning-box">
                    <h3>‚ö†Ô∏è Incoh√©rences d√©tect√©es</h3>
                    <ul>
                        ${warnings.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                </div>
            `;
            container.innerHTML = html;
        }

        function displayContextInfo(data) {
            document.getElementById('filename').textContent = data.filename || '-';
            document.getElementById('original-name').textContent = data.original_name || '-';
            document.getElementById('range-count').textContent = (data.ranges && data.ranges.length) || 0;

            const ht = document.getElementById('human-title');
            const sl = document.getElementById('slug');
            if (ht) ht.textContent = data.human_title || '‚Äî';
            if (sl) sl.textContent = data.slug || '‚Äî';

            renderSummaryChips(data.subranges_summary || {});
        }

        function renderSubrangesTable(ranges, availableLabels) {
            const tbody = document.getElementById('subranges-tbody');
            tbody.innerHTML = '';

            if (!ranges || ranges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">Aucun sous-range √† classifier</td></tr>';
                return;
            }

            ranges.forEach(range => {
                const tr = document.createElement('tr');
                tr.dataset.rangeId = range.id;

                const colorCell = document.createElement('td');
                colorCell.className = 'range-color-cell';
                colorCell.innerHTML = `<div class="range-color-indicator" style="background-color: ${range.color || '#e2e8f0'}"></div>`;

                const nameCell = document.createElement('td');
                nameCell.className = 'range-name-cell';
                nameCell.textContent = range.name || range.action || '(sans nom)';

                const handsCell = document.createElement('td');
                handsCell.className = 'range-hands-cell';
                handsCell.textContent = range.hand_count || 0;

                const labelCell = document.createElement('td');
                labelCell.className = 'range-label-cell';

                const select = document.createElement('select');
                select.className = 'range-label-select';
                select.dataset.rangeId = range.id;
                select.dataset.originalLabel = range.label_canon;

                Object.entries(availableLabels).forEach(([value, label]) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    if (value === range.label_canon) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                select.addEventListener('change', (e) => {
                    const rangeId = parseInt(e.target.dataset.rangeId);
                    const originalLabel = e.target.dataset.originalLabel;
                    const newLabel = e.target.value;

                    if (newLabel !== originalLabel) {
                        modifiedLabels[rangeId] = newLabel;
                        e.target.classList.add('modified');
                    } else {
                        delete modifiedLabels[rangeId];
                        e.target.classList.remove('modified');
                    }

                    updateModifiedCount();
                });

                labelCell.appendChild(select);

                tr.appendChild(colorCell);
                tr.appendChild(nameCell);
                tr.appendChild(handsCell);
                tr.appendChild(labelCell);

                tbody.appendChild(tr);
            });
        }

        function updateModifiedCount() {
            const count = Object.keys(modifiedLabels).length;
            const indicator = document.getElementById('modified-count');

            if (count > 0) {
                indicator.innerHTML = `<span class="modified-indicator"></span> ${count} modifi√©${count > 1 ? 's' : ''}`;
            } else {
                indicator.innerHTML = '';
            }
        }

        function renderSummaryChips(summary) {
            const box = document.getElementById('subranges-summary');
            if (!box) return;
            box.innerHTML = '';
            const keys = Object.keys(summary || {});
            if (keys.length === 0) {
                box.innerHTML = '<span class="small-dim">Aucun sous-range d√©tect√©</span>';
                return;
            }

            const labels = contextData?.available_labels || {};
            keys.forEach(key => {
                const chip = document.createElement('span');
                chip.className = 'chip';
                const label = labels[key] || key;
                chip.textContent = `${label} ¬∑ ${summary[key]}`;
                box.appendChild(chip);
            });
        }

        async function renameFile() {
            const slugEl = document.getElementById('slug');
            const slug = slugEl.textContent.trim();

            if (!slug || slug === '‚Äî') {
                showMessage('Slug non disponible', 'error');
                return;
            }

            const btn = document.getElementById('rename-btn');
            const originalText = btn.textContent;

            const newFilename = `${slug}.json`;
            if (!confirm(`Renommer le fichier en "${newFilename}" ?\n\nCette action est irr√©versible.`)) {
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Renommage...';

            try {
                const response = await fetch(`/api/validation/rename-file/${contextId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`‚úÖ ${result.message}`, 'success');

                    if (result.new_name) {
                        document.getElementById('filename').textContent = result.new_name;
                    }

                    btn.textContent = '‚úì Fichier renomm√©';
                    btn.style.background = '#10b981';
                    btn.style.color = 'white';

                } else {
                    showMessage(`‚ùå ${result.message}`, 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }

            } catch (error) {
                console.error('Erreur renommage:', error);
                showMessage('Erreur lors du renommage', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function prefillForm(data) {
            if (data.table_format) {
                selectOption('table-format', data.table_format);
                currentTableFormat = data.table_format;
            }
            if (data.hero_position) selectOption('hero-position', data.hero_position);

            if (data.primary_action) {
                document.querySelectorAll('.action-btn').forEach(btn => {
                    if (btn.dataset.value === data.primary_action) {
                        btn.classList.add('selected');
                        document.getElementById('primary-action').value = data.primary_action;
                        showDynamicSection(data.primary_action);
                    }
                });

                // üÜï Pr√©-remplir action_sequence si pr√©sent
                if (data.action_sequence) {
                    const seq = data.action_sequence;

                    if (data.primary_action === 'defense' && seq.opener) {
                        setTimeout(() => selectOption('opener', seq.opener), 100);
                    }

                    if (data.primary_action === 'squeeze') {
                        if (seq.opener) {
                            setTimeout(() => selectOption('squeeze-opener', seq.opener), 100);
                        }
                        if (seq.callers) {
                            selectedCallers = seq.callers;
                            setTimeout(() => renderSelectedCallers(), 100);
                        }
                    }

                    if (data.primary_action === 'vs_limpers' && seq.limpers) {
                        selectedLimpers = seq.limpers;
                        setTimeout(() => renderSelectedLimpers(), 100);
                    }
                }
            }

            if (data.stack_depth) document.getElementById('stack-depth').value = data.stack_depth;
            if (data.game_type) document.getElementById('game-type').value = data.game_type;
            if (data.variant) document.getElementById('variant').value = data.variant;
            if (data.sizing) document.getElementById('sizing').value = data.sizing;
            if (data.stakes) document.getElementById('stakes').value = data.stakes;
        }

        function selectOption(fieldId, value) {
            const buttons = document.querySelectorAll(`#${fieldId}-buttons .btn-option`);
            buttons.forEach(btn => {
                if (btn.dataset.value === value) {
                    btn.click();
                }
            });
        }

        // üÜï Afficher/masquer sections dynamiques selon primary_action
        function showDynamicSection(action) {
            // Masquer toutes les sections dynamiques
            document.querySelectorAll('.dynamic-section').forEach(section => {
                section.classList.remove('visible');
            });

            // Afficher la bonne section
            if (action === 'defense') {
                document.getElementById('defense-details').classList.add('visible');
                updateDynamicPositionButtons('opener');
            } else if (action === 'squeeze') {
                document.getElementById('squeeze-details').classList.add('visible');
                updateDynamicPositionButtons('squeeze-opener');
                updateDynamicPositionButtons('callers');
            } else if (action === 'vs_limpers') {
                document.getElementById('limpers-details').classList.add('visible');
                updateDynamicPositionButtons('limpers');
            }
        }

        // üÜï Mettre √† jour les boutons de positions dynamiques
        function updateDynamicPositionButtons(target) {
            const positions = POSITIONS_BY_FORMAT[currentTableFormat];
            const container = document.getElementById(`${target}-buttons`);

            if (!container) return;

            container.innerHTML = '';

            positions.forEach(pos => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-option';
                btn.dataset.value = pos;
                btn.textContent = pos;

                if (target === 'callers') {
                    btn.addEventListener('click', () => addCaller(pos));
                } else if (target === 'limpers') {
                    btn.addEventListener('click', () => addLimper(pos));
                } else {
                    // opener ou squeeze-opener
                    btn.addEventListener('click', (e) => {
                        container.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        document.getElementById(target.replace('-buttons', '')).value = pos;
                    });
                }

                container.appendChild(btn);
            });
        }

        // üÜï G√©rer les callers (squeeze)
        function addCaller(position) {
            if (!selectedCallers.includes(position)) {
                selectedCallers.push(position);
                renderSelectedCallers();
            }
        }

        function removeCaller(position) {
            selectedCallers = selectedCallers.filter(p => p !== position);
            renderSelectedCallers();
        }

        function renderSelectedCallers() {
            const container = document.getElementById('callers-container');
            container.innerHTML = '';

            if (selectedCallers.length === 0) {
                container.innerHTML = '<span class="small-dim">Aucun caller s√©lectionn√©</span>';
            } else {
                selectedCallers.forEach(pos => {
                    const tag = document.createElement('div');
                    tag.className = 'position-tag';
                    tag.innerHTML = `${pos} <button onclick="removeCaller('${pos}')">√ó</button>`;
                    container.appendChild(tag);
                });
            }

            document.getElementById('callers').value = selectedCallers.join(',');
        }

        // üÜï G√©rer les limpers (vs_limpers)
        function addLimper(position) {
            if (!selectedLimpers.includes(position)) {
                selectedLimpers.push(position);
                renderSelectedLimpers();
            }
        }

        function removeLimper(position) {
            selectedLimpers = selectedLimpers.filter(p => p !== position);
            renderSelectedLimpers();
        }

        function renderSelectedLimpers() {
            const container = document.getElementById('limpers-container');
            container.innerHTML = '';

            if (selectedLimpers.length === 0) {
                container.innerHTML = '<span class="small-dim">Aucun limpeur s√©lectionn√©</span>';
            } else {
                selectedLimpers.forEach(pos => {
                    const tag = document.createElement('div');
                    tag.className = 'position-tag';
                    tag.innerHTML = `${pos} <button onclick="removeLimper('${pos}')">√ó</button>`;
                    container.appendChild(tag);
                });
            }

            document.getElementById('limpers').value = selectedLimpers.join(',');
        }

        // G√©rer la s√©lection du format de table
        document.getElementById('table-format-buttons').addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-option')) {
                document.querySelectorAll('#table-format-buttons .btn-option').forEach(btn => {
                    btn.classList.remove('selected');
                });
                e.target.classList.add('selected');
                const format = e.target.dataset.value;
                document.getElementById('table-format').value = format;
                currentTableFormat = format;
                updatePositionButtons(format);

                // R√©initialiser aussi les positions dynamiques
                const primaryAction = document.getElementById('primary-action').value;
                if (primaryAction) {
                    showDynamicSection(primaryAction);
                }
            }
        });

        function updatePositionButtons(format) {
            const positions = POSITIONS_BY_FORMAT[format];

            const heroContainer = document.getElementById('hero-position-buttons');
            heroContainer.innerHTML = '';
            positions.forEach(pos => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-option hero-btn';
                btn.dataset.value = pos;
                btn.textContent = pos;
                heroContainer.appendChild(btn);
            });

            document.getElementById('hero-position').value = '';
            document.querySelectorAll('.hero-btn').forEach(btn => btn.classList.remove('selected'));
        }

        // G√©rer les clics sur les boutons d'action
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                const action = btn.dataset.value;
                document.getElementById('primary-action').value = action;
                showDynamicSection(action);
            });
        });

        document.getElementById('hero-position-buttons').addEventListener('click', (e) => {
            if (e.target.classList.contains('hero-btn')) {
                document.querySelectorAll('.hero-btn').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
                document.getElementById('hero-position').value = e.target.dataset.value;
            }
        });

        // Soumettre le formulaire
        document.getElementById('validation-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const allRangeLabels = {};
            document.querySelectorAll('.range-label-select').forEach(select => {
                const rangeId = parseInt(select.dataset.rangeId);
                const label = select.value;
                allRangeLabels[rangeId] = label;
            });

            const primaryAction = document.getElementById('primary-action').value;

            const formData = {
                table_format: document.getElementById('table-format').value,
                hero_position: document.getElementById('hero-position').value,
                primary_action: primaryAction,
                stack_depth: document.getElementById('stack-depth').value,
                game_type: document.getElementById('game-type').value,
                variant: document.getElementById('variant').value,
                sizing: document.getElementById('sizing').value,
                stakes: document.getElementById('stakes').value,
                update_json: document.getElementById('update-json').checked,
                range_labels: Object.keys(allRangeLabels).length > 0 ? allRangeLabels : null
            };

            // üÜï Ajouter les champs sp√©cifiques selon primary_action
            if (primaryAction === 'defense') {
                formData.opener = document.getElementById('opener').value;
            } else if (primaryAction === 'squeeze') {
                formData.opener = document.getElementById('squeeze-opener').value;
                formData.callers = document.getElementById('callers').value;
            } else if (primaryAction === 'vs_limpers') {
                formData.limpers = document.getElementById('limpers').value;
            }

            if (!formData.table_format || !formData.hero_position || !formData.primary_action) {
                showMessage('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            // Validation sp√©cifique selon primary_action
            if (primaryAction === 'defense' && !formData.opener) {
                showMessage('Veuillez s√©lectionner la position de l\'ouvreur', 'error');
                return;
            }
            if (primaryAction === 'squeeze' && (!formData.opener || !formData.callers)) {
                showMessage('Veuillez s√©lectionner l\'ouvreur et au moins un caller', 'error');
                return;
            }
            if (primaryAction === 'vs_limpers' && !formData.limpers) {
                showMessage('Veuillez s√©lectionner au moins un limpeur', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/validation/validate/${contextId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    setTimeout(() => { window.location.href = '/?validated=true'; }, 1500);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Erreur lors de la validation', 'error');
                console.error(error);
            }
        });

        document.getElementById('btn-ignore').addEventListener('click', async () => {
            if (!confirm('√ätes-vous s√ªr de vouloir marquer ce contexte comme non exploitable ?')) return;

            try {
                const response = await fetch(`/api/validation/ignore/${contextId}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showMessage('Contexte marqu√© comme non exploitable', 'success');
                    setTimeout(() => { window.location.href = '/'; }, 1500);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Erreur lors de l\'op√©ration', 'error');
                console.error(error);
            }
        });

        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
            if (type === 'success') setTimeout(() => { container.innerHTML = ''; }, 3000);
        }

        loadContext();
    </script>
</body>
</html>