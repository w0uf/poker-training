<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test API Quiz</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px 0; }
        pre { background: #000; padding: 10px; overflow-x: auto; border: 1px solid #0f0; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #ff0; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic API Quiz</h1>

    <h2>√âtape 1 : V√©rifier les contextes disponibles</h2>
    <button onclick="testGetContexts()">Charger les contextes</button>
    <pre id="contextsResult"></pre>

    <h2>√âtape 2 : Tester l'API de g√©n√©ration</h2>
    <label>ID du contexte : <input type="number" id="contextId" value="4"></label>
    <button onclick="testGenerateQuiz()">G√©n√©rer 5 questions</button>
    <pre id="generateResult"></pre>

    <h2>√âtape 3 : Tester sessionStorage</h2>
    <button onclick="testSessionStorage()">Test sessionStorage</button>
    <pre id="storageResult"></pre>

    <h2>√âtape 4 : Simuler le flux complet</h2>
    <button onclick="testFullFlow()">Flux complet (comme le vrai quiz)</button>
    <pre id="fullFlowResult"></pre>

    <script>
        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            el.innerHTML += `<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span>\n`;
        }

        async function testGetContexts() {
            const el = document.getElementById('contextsResult');
            el.innerHTML = '';
            log('contextsResult', 'üîÑ Chargement des contextes...');

            try {
                const response = await fetch('/api/quiz/available-contexts');
                log('contextsResult', `Status: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log('contextsResult', `‚úÖ ${data.contexts.length} contextes trouv√©s`, 'success');
                log('contextsResult', JSON.stringify(data.contexts, null, 2));
            } catch (error) {
                log('contextsResult', `‚ùå ERREUR: ${error.message}`, 'error');
            }
        }

        async function testGenerateQuiz() {
            const el = document.getElementById('generateResult');
            el.innerHTML = '';
            const contextId = parseInt(document.getElementById('contextId').value);

            log('generateResult', `üîÑ G√©n√©ration de 5 questions pour contexte ${contextId}...`);

            try {
                const response = await fetch('/api/quiz/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        context_ids: [contextId],
                        question_count: 5,
                        variants: {}
                    })
                });

                log('generateResult', `Status: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();

                if (data.error) {
                    log('generateResult', `‚ùå ERREUR API: ${data.error}`, 'error');
                } else if (data.questions) {
                    log('generateResult', `‚úÖ ${data.questions.length} questions g√©n√©r√©es`, 'success');
                    log('generateResult', JSON.stringify(data.questions, null, 2));
                } else {
                    log('generateResult', `‚ö†Ô∏è R√©ponse inattendue: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log('generateResult', `‚ùå ERREUR: ${error.message}`, 'error');
            }
        }

        async function testSessionStorage() {
            const el = document.getElementById('storageResult');
            el.innerHTML = '';

            log('storageResult', 'üîÑ Test sessionStorage...');

            // Tester l'√©criture
            const testData = { test: 'data', timestamp: Date.now() };
            sessionStorage.setItem('test_quiz', JSON.stringify(testData));
            log('storageResult', '‚úÖ √âcriture OK', 'success');

            // Tester la lecture
            const retrieved = sessionStorage.getItem('test_quiz');
            if (retrieved) {
                log('storageResult', '‚úÖ Lecture OK', 'success');
                log('storageResult', `Donn√©es: ${retrieved}`);
            } else {
                log('storageResult', '‚ùå Lecture FAILED', 'error');
            }

            // V√©rifier quizQuestions
            const quizData = sessionStorage.getItem('quizQuestions');
            if (quizData) {
                log('storageResult', '‚úÖ quizQuestions existe', 'success');
                log('storageResult', `Taille: ${quizData.length} caract√®res`);
                try {
                    const parsed = JSON.parse(quizData);
                    log('storageResult', `${parsed.length} questions stock√©es`);
                } catch (e) {
                    log('storageResult', '‚ùå JSON invalide', 'error');
                }
            } else {
                log('storageResult', '‚ö†Ô∏è quizQuestions est vide', 'info');
            }
        }

        async function testFullFlow() {
            const el = document.getElementById('fullFlowResult');
            el.innerHTML = '';
            const contextId = parseInt(document.getElementById('contextId').value);

            log('fullFlowResult', 'üîÑ FLUX COMPLET...');

            // √âtape 1 : G√©n√©rer le quiz
            log('fullFlowResult', '√âtape 1/3 : Appel API...');
            try {
                const response = await fetch('/api/quiz/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        context_ids: [contextId],
                        question_count: 5,
                        variants: {}
                    })
                });

                log('fullFlowResult', `Status: ${response.status}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const data = await response.json();

                if (!data.questions || data.questions.length === 0) {
                    log('fullFlowResult', '‚ùå Aucune question dans la r√©ponse', 'error');
                    return;
                }

                log('fullFlowResult', `‚úÖ ${data.questions.length} questions re√ßues`, 'success');

                // √âtape 2 : Stocker dans sessionStorage
                log('fullFlowResult', '√âtape 2/3 : Stockage sessionStorage...');
                sessionStorage.setItem('quizQuestions', JSON.stringify(data.questions));
                log('fullFlowResult', '‚úÖ Stockage OK', 'success');

                // √âtape 3 : V√©rifier la lecture
                log('fullFlowResult', '√âtape 3/3 : V√©rification lecture...');
                const stored = sessionStorage.getItem('quizQuestions');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    log('fullFlowResult', `‚úÖ ${parsed.length} questions r√©cup√©r√©es`, 'success');
                    log('fullFlowResult', '‚úÖ FLUX COMPLET OK !', 'success');
                    log('fullFlowResult', '\nüöÄ Tu peux maintenant aller sur /quiz');
                } else {
                    log('fullFlowResult', '‚ùå sessionStorage vide apr√®s stockage', 'error');
                }

            } catch (error) {
                log('fullFlowResult', `‚ùå ERREUR: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>